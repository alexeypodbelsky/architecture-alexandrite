# Существующие и потенциальные проблемные места


1. MES расчитывает стоимость производства изделия в зависимости от полигонов 3D моделей и время занимает от 2 до 30 минут, что неприемлемо долго для пользователей онлайн-магазина и API. Это приводит к потере клиентов и замедлению работы. 

2. Даже после добавления фильтрации и пагинации первая страница MES долго прогружается. Операторам MES важно видеть самые новые заказы. От этого зависит их вознаграждение. 

3. Потенциальная перегрузка базы данных MES. Увеличение количества заказов может усугубить проблемы с производительностью MES. Как известно, каждый месяц колическтво заказов увеличиваются минимум на 100 по сравнению с предыдущим.  

4. Один инстанс базы данных для чтения и записи. Сбой в этой части приведет к полной остановке системы. 

5. Риск потери сообщений в RabbitMQ, если не используется механизм подтверждения доставки. 

6. Не обесепечена достаточная наблюдаемость системы: отсутствует логирование, мониторинг и трассировка, что затрудняет выявление и диагностику проблем. Невозможно отслеживать динамику проблем.

7. Ручное тестирование перед деплоем на продакшн замедляет процесс релиза и является узким местом.

8. С точки зрения бизнеса проблемы следующие: жалобы клиентов в связи с задержками в обработке заказов и потерей заказов; потеря крупных контрактов; демотивация операторов MES из-за медленной работы системы, потому что это влияет на их вознаграждение.


# Инициативы (по приоритету)


1. Нужно первым делом организовать наблюдаемость системы. Без этого невозможно получить четкое представление о том, как система работает сейчас, какие компоненты испытывают наибольшую нагрузку, где возникают задержки и ошибки. Организация наблюдаемости системы должна быть первым приоритетом, даже до начала каких-либо других инициатив по оптимизации или изменению архитектуры. Что можно рассмотреть:
	- Мониторинг: "Prometheus + Grafana" или "VictoriaMetrics + Grafana"
	- Логирование: "ELK Stack" или "VictoriaLogs + Grafana"
	- Трейсинг: "Jaeger" или "Zipkin"
	- Возможно интегрированные облачные сервисы мониторинга, т.к. сервисы развернуты в облаке

2. Оптимизировать логику расчета стоимости в MES. Для этого применить профилирование кода, оптимизацию алгоритмов, кэширование результатов расчетов моделей на некоторое время. Использовать более мощный CPU и использовать многозадачность для расчетов. 

3. Оптимизировать загрузку данных страницы новых заказов в MES. Скорее всего проблема кроется в медленном взаимодействии с базой данных. Если это так, то используем паттерны кеширования Cache-Aside и Write-Through с программной инвалидацией:
 
	- Write-Through: при создании нового заказа данные сразу записываются и в базу данных, и в кеш. 
	
	- Cache-Aside: при запросе данных о новых заказах система сначала проверяет наличие данных в кеше. Если данные есть в кеше, они возвращаются. Если данных в кеше нет, система запрашивает данные из базы данных, записывает их в кеш и возвращает (так исключим кеш-промах). 
  
	- Программная инвалидация: когда заказ переходит в статус "MANUFACTURING_STARTED" (оператор взял заказ в работу), происходит программная инвалидация кеша для этого заказа. Это гарантирует, что этот заказ больше не будет отображаться в списке новых заказов. 

4. Небходимо организовать автоматизацию тестирования системы на уровне E2E, чтобы ускорить релизы, сократить количечтво багов в релизе и уменьшить зависимость от ручного тестирования. Также необходимо организовать автотестирование API сервисов (запуск тестовых Postman - коллекций через newman автоматически на этапе CI в пайплайне после юнит-тестов). Лучше организовать найм еще одного инженера-специалиста по автоматизированному тестированию.  

5. Чтобы уменьшить нагрузку на БД MES рассмотрим следующий вариант: операции чтения переносятся на реплику, что освобождает ресурсы основного сервера для операций записи. У нас есть Yandex Cloud Managed Services и PostgreSQL. Можно относительно легко настроить репликацию master-slave и использовать паттерн read-replica. Master-Slave репликация: архитектура, в которой есть один основной сервер, на который производятся все операции записи и один или несколько вторичных серверов, которые реплицируют данные с основного сервера. Read-Replica: приложение направляет все операции чтения на вторичные серверы, а операции записи - на основной сервер. Можно пока ограничиться одним сервером на запись и одним - на чтение. 


# Возможный вариант целевой архитектуры через полгода, если бы была возможность выполнить только три пункта из списка инициатив


1. Организовать наблюдаемость системы (подробный ход мыслей в п.1 раздела "# Инициативы" выше).

2. Оптимизировать логику расчета стоимости в MES (подробный ход мыслей в п.2 раздела "# Инициативы" выше). 

3. Оптимизировать загрузку данных страницы новых заказов в MES (подробный ход мыслей в п.3 раздела "# Инициативы" выше). 









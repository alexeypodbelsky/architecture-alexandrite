# Мотивация


1. Мониторинг позволит обнаруживать проблемы до того, как они повлияют на клиентов или бизнес-процессы. Например, можно заметить увеличение времени отклика API до того, как клиенты начнут жаловаться на медленную работу.

2. Когда проблема возникает, мониторинг предоставляет данные, необходимые для быстрой диагностики и устранения. Без мониторинга поиск первопричины проблемы может занять много времени, что приводит к простоям и потере клиентов.

3. Мониторинг помогает выявлять узкие места в системе и оптимизировать производительность. Например, можно обнаружить, что определенный запрос к базе данных занимает слишком много времени, и оптимизировать его.

4. Мониторинг предоставляет данные, необходимые для принятия обоснованных решений о масштабировании, оптимизации ресурсов и планировании будущих разработок. Например, можно использовать данные мониторинга, чтобы определить, когда необходимо добавить новые инстансы приложений или оптимизировать код.

5. После внесения изменений в систему мониторинг позволяет оценить их эффективность. Например, можно увидеть, улучшилась ли производительность после оптимизации кода или добавления новых инстансов приложений.

6. Подключение мониторинга позволит связать технические метрики с бизнес-показателями, такими как, например, количество заказов. Это позволит принимать более эффективные решения и измерять влияние технических изменений на бизнес.


# Выбор подхода к мониторингу


Будем использовать комбинацию подходов RED и USE:

- RED (Requests, Errors, Duration) для API (интернет-магазин, CRM, MES).

- USE (Utilization, Saturation, Errors) для инфраструктуры (серверы, базы данных, RabbitMQ).


# Метрики по сервисам

Для начала выделим список основных метрик по каждому сервису, чтобы быстрее начать сам мониторинг и отладить его. Позже можно будет добавить дополнительные метрики, если это будет необходимо.  


## RabbitMQ


### 1. Number of dead-letter-exchange letters in RabbitMQ 

- Показывает, сколько сообщений не были обработаны и попали в "мертвую" очередь. Это может указывать на проблемы с обработкой сообщений, неверные конфигурации или ошибки в коде.
- Ярлыки: exchange, routing_key, reason. 
- Подход: USE.


### 2. Number of message in flight in RabbitMQ

- Показывает, сколько сообщений в данный момент находятся в процессе обработки. Рост этой метрики может свидетельствовать о перегрузке системы или проблемах с обработкой сообщений.
- Ярлыки: queue, consumer. 
- Подход: USE


## Интернет-магазин (Shop API)


### 1. Number of requests (RPS) for internet shop API

- Показывает нагрузку на API интернет-магазина. Используется для оценки требуемых ресурсов и выявления аномалий.
- Ярлыки: endpoint, method.
- Подход: RED.


### 2. CPU % for shop API

- Показывает загрузку процессора для API интернет-магазина. Используется для выявления перегрузок и оптимизации кода.
- Ярлыки: instance.
- Подход: USE.


### 3. Memory Utilisation for shop API

- Показывает использование памяти API интернет-магазина. Используется для выявления утечек памяти и оптимизации использования памяти.
- Ярлыки: instance.
- Подход: USE.


### 4. Response time (latency) for shop API

- Показывает время отклика API интернет-магазина. Используется для выявления проблем с производительностью и оптимизации кода.
- Ярлыки: endpoint, method.
- Подход: RED.


### 5. Number of HTTP 500 for shop API

- Показывает количество ошибок сервера API интернет-магазина. Используется для выявления проблем в коде и инфраструктуре.
- Ярлыки: endpoint, method.
- Подход: RED.



## CRM API


### 1. Number of requests (RPS) for CRM API

- Показывает нагрузку на API CRM. Используется для оценки требуемых ресурсов и выявления аномалий.
- Ярлыки: endpoint, method.
- Подход: RED.


### 2. CPU % for CRM API

- Показывает загрузку процессора для API CRM. Используется для выявления перегрузок и оптимизации кода.
- Ярлыки: instance.
- Подход: USE.


### 3. Memory Utilisation for CRM API

- Показывает использование памяти API CRM. Используется для выявления утечек памяти и оптимизации использования памяти.
- Ярлыки: instance.
- Подход: USE.


### 4. Response time (latency) for CRM API

- Показывает время отклика API CRM. Используется для выявления проблем с производительностью и оптимизации кода.
- Ярлыки: endpoint, method.
- Подход: RED.


### 5. Number of HTTP 500 for CRM API

- Показывает количество ошибок сервера API CRM. Используется для выявления проблем в коде и инфраструктуре.
- Ярлыки: endpoint, method.
- Подход: RED.


## MES API


### 1. Number of requests (RPS) for MES API

- Показывает нагрузку на API MES. Используется для оценки требуемых ресурсов и выявления аномалий.
- Ярлыки: endpoint, method.
- Подход: RED.


### 2. Number of requests (RPS) per user for MES API

- Показывает, как часто каждый пользователь обращается к API MES. Помогает выявить пользователей, которые злоупотребляют API
- Ярлыки: user_id, endpoint, method.
- Подход: RED.


### 3. CPU % for MES API

- Показывает загрузку процессора для API MES. Используется для выявления перегрузок и оптимизации кода.
- Ярлыки: instance.
- Подход: USE.


### 4. Memory Utilisation for MES API

- Показывает использование памяти API MES. Используется для выявления утечек памяти и оптимизации использования памяти.
- Ярлыки: instance.
- Подход: USE.


### 5. Response time (latency) for MES API

- Показывает время отклика API MES. Используется для выявления проблем с производительностью и оптимизации кода.
- Ярлыки: endpoint, method.
- Подход: RED.


### 6. Number of HTTP 500 for MES API

- Показывает количество ошибок сервера API MES. Используется для выявления проблем в коде и инфраструктуре.
- Ярлыки: endpoint, method.
- Подход: RED.


### 7. Number of simultanious sessions for MES API

- Показывает количество одновременных сессий пользователей в MES. Используется для оценки нагрузки и планирования ресурсов.
- Ярлыки: нет.
- Подход: USE.


## Базы данных (Shop DB и MES DB)


### 1. Memory Utilisation for shop db instance

- Показывает использование памяти инстанса базы данных интернет-магазина. Используется для выявления нехватки памяти и оптимизации конфигурации базы данных.
- Ярлыки: нет.
- Подход: USE.


### 2. Memory Utilisation for MES db instance

- Показывает использование памяти инстанса базы данных MES. Используется для выявления нехватки памяти и оптимизации конфигурации базы данных.
- Ярлыки: нет.
- Подход: USE.


### 3. Number of connections for MES db instance

- Показывает количество активных соединений с базой данных MES. Используется для выявления перегрузок и оптимизации пула соединений.
- Ярлыки: нет.
- Подход: USE.


### 4. Size of shop db instance

- Показывает размер базы данных интернет-магазина. Используется для планирования ресурсов и выявления аномалий.
- Ярлыки: нет.
- Подход: USE.


### 5. Size of MES db instance

- Показывает размер базы данных MES. Используется для планирования ресурсов и выявления аномалий.
- Ярлыки: нет.
- Подход: USE.


## S3 Storage


### 1. Size of S3 storage

- Показывает объем используемого хранилища S3. Используется для планирования ресурсов и выявления аномалий.
- Ярлыки: bucket.
- Подход: USE.


# План действий


## 1. Подготовить инструментоы мониторинга

- Развернуть инстанс Prometheus (или VictoriaMetrics) в Yandex Cloud (можно использовать Managed Service, если есть).

- Развернуть инстанс Grafana в Yandex Cloud (можно использовать Managed Service).


## 2. Настроить сбор метрик:

- RabbitMQ:
	- Использовать rabbitmq_exporter (или Prometheus plugin для RabbitMQ).
	
- API (Интернет-магазин, CRM, MES):
	- Реализовать решение для экспорта метрик в формате Prometheus.

- Базы данных:
	- Реализовать решения для экспорта метрик БД в формате Prometheus.


## 3. Настроить визуализации и алертинг:

- Создать дашборды для каждого сервиса с отображением основных метрик. Настроить графики и другие элементы визуализации для удобного анализа данных.

- Определить пороговые значения для каждой метрики.
    

## 4. Провести тестирование и отладку:

- Провести тестирование для проверки работоспособности алертов. Смоделировать различные сценарии сбоев и убедиться, что система мониторинга обнаруживает их. Отладить конфигурацию системы мониторинга. 

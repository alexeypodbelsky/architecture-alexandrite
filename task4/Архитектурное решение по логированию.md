# Cписок необходимых логов с уровнем INFO


## Shop API:

1. [INFO] Получен новый запрос на создание заказа. ID заказа: {order_id}, ID пользователя: {user_id}, 3D модель: {file_name}, {file_id}.

2. [INFO] Заказ {order_id} отправлен в Shop DB.
  
3. [INFO] Запрос к 3D files storage. Название файла: {file_name}, размер файла: {file_size}.


## CRM API:
  
1. [INFO] Обнаружен новый заказ в Shop DB. ID заказа: {order_id}.

2. [INFO] Отправлено сообщение в RabbitMQ для заказа {order_id}. Routing key: {routing_key}.

3. [INFO] Завершен процесс обработки заказа {order_id}.

4. [INFO] Получено сообщение из RabbitMQ (от MES) для заказа {order_id}.


## MES API:

1. [INFO] Получено сообщение из RabbitMQ для заказа {order_id}.

2. [INFO] Начало расчета стоимости для заказа {order_id}.

3. [INFO] Расчет стоимости завершен для заказа {order_id}. Стоимость: {price}.
  
4. [INFO] Заказ {order_id} отправлен в MES DB.
  
5. [INFO] Запрос к 3D files storage для заказа {order_id}, 3D модель: {file_name}, {file_id}.

6. [INFO] Оператор {operator_id} взял заказ {order_id} в работу.

7. [INFO] Статус заказа {order_id} изменен на {status}.

8. [INFO] Отправлено сообщение в RabbitMQ для заказа {order_id}. Routing key: {routing_key}.


# Другие типы сообщений 

- Проблемы с API можно помечать [WARN]
- 500-е ошибки внутренних проблем сервера можно помечать [ERROR]


# Мотивация

## Почему нужно логирование:

1. Логирование позволит быстро определить причину ошибок и задержек в обработке заказов, сокращая время простоя системы. Сейчас, чтобы разобраться с проблемой, нужно опираться только на слова клиента.
  
2. Анализ логов может помочь выявить ошибки в коде и оптимизировать работу системы.

3. Логирование позволит отслеживать ключевые этапы обработки заказов, выявлять узкие места и повышать эффективность работы компании.


## Технические и бизнес-метрики:

1. Процент заказов, обработанных без задержек

2. Количество потерянных заказов

3. Удовлетворенность клиентов


## Приоритеты по внедрению логирования и трейсинга:

В первую очередь логирование необходимо внедрить в MES API, Shop API и CRM API. Это ключевые компоненты, через которые проходят заказы. Важно иметь возможность выявлять причины задержек. Трейсинг стоит подключать, начиная с Shop API и MES API Это позволит понять, как взаимодействуют сервисы, которые принимают заказ от пользователя, как долго он ждет, что происходит после того, как заказ создан.


# Предлагаемое решение

Для логирования будем использовать ELK стек. 

1. Развернем инстансы Filebeat как отдельные контейнеры рядом с каждым сервисом (Shop API, CRM API, MES API). Filebeat должен иметь доступ к файловой системе контейнера, где хранятся логи. 

2. Развернем один инстанс Logstash как отдельный контейнер

3. Развернем ElasticSearch + Kibana

Диаграмма контейнеров с логированием (можно найти рядом с этим .md в одной папке): [log_jewerly_c4_model.drawio](log_jewerly_c4_model.drawio)


# Политика безопасности

1. Нельзя логировать персональные данные клиентов

2. Запрещено логировать пароли.

3. Доступ к Kibana должен быть ограничен для авторизованных пользователей (DevOps-инженеры, тимлиды).


# Политика хранения логов

Для каждой системы создадим отдельный индекс в Elasticsearch

1. Храним логи в течение 30 дней.
2. Ограничиваем размер индекса для каждой системы (например, 100 GB).


# Сиситема анализа логов

Алертинг пока не настраиваем. При дальнейшем анализе логов скорее всего примем решение, на что ставить алерты. Возможно, это будут 500-е ошибки > 100 за минуту или случай, когда обнаружена попытка создания за секунду >= 10000 заказов (DDoS) 
# Места, где заказ может "сломаться" или зависнуть:

1. Задержка между Shop API и CRM API. CRM API (судя по схеме) периодически проверяет Shop DB, а не получает мгновенное уведомление о новом заказе.

2. Потеря сообщений или задержки в очереди RabbitMQ

3. Проблемы с расчетом стоимости в MES API (особенно для сложных 3D-моделей), ошибки при взаимодействии с MES DB или 3D Files Storage.

4. Запросы между MES API и MES DB могут занимать слишком много времени.


# Определим сценарии трейсинга:

1. Создание заказа через интернет-магазин:
Shop API -> Shop DB -> CRM API -> RabbitMQ -> MES API -> MES DB

2. Создание заказа через API (B2B):
MES API -> MES DB -> RabbitMQ -> CRM API -> Shop DB

# Данные, которые должны попадать в трейсинг:

- ID заказа
- ID пользователя
- Время создания заказа
- Статус заказа
- HTTP-запросы (метод, URL, заголовки)
- Сообщения RabbitMQ (ID сообщения, routing key)
- Запросы к базам данных (SQL-запрос, время выполнения)
- ID инстанса сервиса, обрабатывающего запрос
- Ошибки и исключения


# Мотивация

Заказы "зависают" в системе, теряются, не отслеживается их текущее состояние. Это приводит к недовольству клиентов, потере контрактов, демотивации сотрудников.

Почему нужен трейсинг:

1. Трейсинг позволяет быстро выявлять причину задержек или ошибок в обработке заказов, сокращая время на поиск и устранение неисправностей
2. Трейсинг помогает находить узкие места в системе и оптимизировать процессы обработки заказов
3. Трейсинг позволяет выявлять места, где сообщения теряются, и принимать меры для их предотвращения

Технические и бизнес-метрики, на которые повлияет внедрение трейсинга:

1. Среднее время обработки заказа
2. Процент успешно выполненных заказов
3. Количество потерянных заказов
4. Удовлетворенность клиентов


# Предлагаемое решение

Для реализации трейсинга предлагается использовать OpenTelemetry (sdk OTel) в связке с "Jaeger All-in-One". OpenTelemetry SDK внедрим в код сервисов: "Shop API", "CRM API" и "MES API". Они будут отправлять данные трассировки в "Jaeger All-in-One". Пока можно сделать такой простой вариант развертывания (All-in-One) и не разворачивать агенты. Лучше сосредоточиться на доработке кода сервисов.

Обновленная диаграмма контейнеров (можно найти рядом с этим .md в одной папке): [jewerly_c4_model.drawio](jewerly_c4_model.drawio) 


# Компромиссы

В каких случаях трейсинг не принесёт пользы или пока невозможен, или его реализация обойдётся слишком дорого:

1. Внедрение трейсинга требует модификации кода всех сервисов, что может быть сложным и трудоемким процессом

2. Развертывание и обслуживание Jaeger требует дополнительных ресурсов (вычислительные мощности, хранилище), что может привести к увеличению затрат

3. Если код сервисов сложно модифицировать, внедрение трейсинга может быть нецелесообразным


# Аспекты безопасности 

1. Доступ к Jaeger UI должен быть только для авторизованных пользователей (например DevOps-инженеров, тимлидов) 

2. Конфиденциальные данные (персональные данные клиентов, пароли) не должны попадать в трейсы











